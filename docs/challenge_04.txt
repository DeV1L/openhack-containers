# https://openhacks.azurewebsites.net/labs/player/microsoft-open-hack-containers-v2_2d85a605ca87_3_0#labGuide
# https://akv2k8s.io/

## Azure Key Vault Provider
https://github.com/Azure/secrets-store-csi-driver-provider-azure/blob/master/charts/csi-secrets-store-provider-azure/README.md

helm repo add csi-secrets-store-provider-azure https://raw.githubusercontent.com/Azure/secrets-store-csi-driver-provider-azure/master/charts
helm install csi-secrets-store-provider-azure/csi-secrets-store-provider-azure --generate-name


# Install 
https://github.com/Azure/secrets-store-csi-driver-provider-azure

...


## Ingress
helm install openhack stable/nginx-ingress

kubectl get service  -o wide
NAME                                     TYPE           CLUSTER-IP    EXTERNAL-IP    PORT(S)                      AGE     SELECTOR
kubernetes                               ClusterIP      10.23.0.1     <none>         443/TCP                      6h48m   <none>
openhack-nginx-ingress-controller        LoadBalancer   10.23.0.176   20.54.196.0    80:30212/TCP,443:30427/TCP   49s     app.kubernetes.io/component=controller,app=nginx-ingress,release=openhack
openhack-nginx-ingress-default-backend   ClusterIP      10.23.0.137   <none>         80/TCP                       49s     app.kubernetes.io/component=default-backend,app=nginx-ingress,release=openhack
poi                                      ClusterIP      10.23.0.5     <none>         80/TCP                       4h10m   app=poi
trips                                    ClusterIP      10.23.0.199   <none>         80/TCP                       159m    app=trips
tripviewer                               LoadBalancer   10.23.0.71    20.50.46.167   80:30821/TCP                 155m    app=tripviewer
user-java                                ClusterIP      10.23.0.142   <none>         80/TCP                       154m    app=user-java
userprofile  


kubectl apply -f .\ingress\ingress.yml

kubectl get ingress
NAME             HOSTS                                                                                                                                                ADDRESS    PORTS   AGE
openhack-team1   openhack-team1.westeurope.cloudapp.azure.com,openhack-team1.westeurope.cloudapp.azure.com,openhack-team1.westeurope.cloudapp.azure.com + 2 more...   10.2.1.4   80      4m44s

# Assign DNS name
http://openhack-team1.westeurope.cloudapp.azure.com/


# Redeploy API and Web

kubectl apply -f .\secret.yaml -n api

kubectl apply -f .\src\poi\deployment.yaml -n api
kubectl apply -f .\src\trips\deployment.yaml -n api
kubectl apply -f .\src\user-java\deployment.yaml -n api
kubectl apply -f .\src\userprofile\deployment.yaml -n api

kubectl apply -f .\src\tripviewer\deployment.yaml -n web



PS G:\git\openhack-containers> kubectl get services --all-namespaces
NAMESPACE     NAME                                     TYPE           CLUSTER-IP    EXTERNAL-IP   PORT(S)                      AGE
api           poi                                      ClusterIP      10.23.0.58    <none>        80/TCP                       15s
api           trips                                    ClusterIP      10.23.0.30    <none>        80/TCP                       12s
api           user-java                                ClusterIP      10.23.0.204   <none>        80/TCP                       9s
api           userprofile                              ClusterIP      10.23.0.53    <none>        80/TCP                       6s
default       kubernetes                               ClusterIP      10.23.0.1     <none>        443/TCP                      21h
default       openhack-nginx-ingress-controller        LoadBalancer   10.23.0.176   20.54.196.0   80:30212/TCP,443:30427/TCP   14h
default       openhack-nginx-ingress-default-backend   ClusterIP      10.23.0.137   <none>        80/TCP                       14h
kube-system   dashboard-metrics-scraper                ClusterIP      10.23.0.143   <none>        8000/TCP                     21h
kube-system   kube-dns                                 ClusterIP      10.23.0.2     <none>        53/UDP,53/TCP                21h
kube-system   kubernetes-dashboard                     ClusterIP      10.23.0.23    <none>        443/TCP                      21h
kube-system   metrics-server                           ClusterIP      10.23.0.252   <none>        443/TCP                      21h
web           tripviewer                               ClusterIP      10.23.0.3     <none>        80/TCP                       9h
