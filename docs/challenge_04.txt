# https://openhacks.azurewebsites.net/labs/player/microsoft-open-hack-containers-v2_2d85a605ca87_3_0#labGuide
# https://akv2k8s.io/

## Azure Key Vault Provider
https://github.com/Azure/secrets-store-csi-driver-provider-azure/blob/master/charts/csi-secrets-store-provider-azure/README.md

helm repo add csi-secrets-store-provider-azure https://raw.githubusercontent.com/Azure/secrets-store-csi-driver-provider-azure/master/charts
helm install csi-secrets-store-provider-azure/csi-secrets-store-provider-azure --generate-name


# Install 
https://github.com/Azure/secrets-store-csi-driver-provider-azure

...


## Ingress
helm install openhack stable/nginx-ingress

kubectl get service  -o wide
NAME                                     TYPE           CLUSTER-IP    EXTERNAL-IP    PORT(S)                      AGE     SELECTOR
kubernetes                               ClusterIP      10.23.0.1     <none>         443/TCP                      6h48m   <none>
openhack-nginx-ingress-controller        LoadBalancer   10.23.0.176   20.54.196.0    80:30212/TCP,443:30427/TCP   49s     app.kubernetes.io/component=controller,app=nginx-ingress,release=openhack
openhack-nginx-ingress-default-backend   ClusterIP      10.23.0.137   <none>         80/TCP                       49s     app.kubernetes.io/component=default-backend,app=nginx-ingress,release=openhack
poi                                      ClusterIP      10.23.0.5     <none>         80/TCP                       4h10m   app=poi
trips                                    ClusterIP      10.23.0.199   <none>         80/TCP                       159m    app=trips
tripviewer                               LoadBalancer   10.23.0.71    20.50.46.167   80:30821/TCP                 155m    app=tripviewer
user-java                                ClusterIP      10.23.0.142   <none>         80/TCP                       154m    app=user-java
userprofile  


kubectl apply -f .\ingress\ingress-web.yml -n web
kubectl apply -f .\ingress\ingress-api.yml -n api

kubectl get ingress
NAME             HOSTS                                                                                                                                                ADDRESS    PORTS   AGE
openhack-team1   openhack-team1.westeurope.cloudapp.azure.com,openhack-team1.westeurope.cloudapp.azure.com,openhack-team1.westeurope.cloudapp.azure.com + 2 more...   10.2.1.4   80      4m44s

# Assign DNS name
http://openhack-team1.westeurope.cloudapp.azure.com/


# Redeploy API and Web

kubectl apply -f .\secret.yaml -n api

kubectl apply -f .\src\poi\deployment.yaml -n api
kubectl apply -f .\src\trips\deployment.yaml -n api
kubectl apply -f .\src\user-java\deployment.yaml -n api
kubectl apply -f .\src\userprofile\deployment.yaml -n api

kubectl apply -f .\src\tripviewer\deployment.yaml -n web



PS G:\git\openhack-containers> kubectl get services --all-namespaces
NAMESPACE     NAME                                     TYPE           CLUSTER-IP    EXTERNAL-IP   PORT(S)                      AGE
api           poi                                      ClusterIP      10.23.0.58    <none>        80/TCP                       15s
api           trips                                    ClusterIP      10.23.0.30    <none>        80/TCP                       12s
api           user-java                                ClusterIP      10.23.0.204   <none>        80/TCP                       9s
api           userprofile                              ClusterIP      10.23.0.53    <none>        80/TCP                       6s
default       kubernetes                               ClusterIP      10.23.0.1     <none>        443/TCP                      21h
default       openhack-nginx-ingress-controller        LoadBalancer   10.23.0.176   20.54.196.0   80:30212/TCP,443:30427/TCP   14h
default       openhack-nginx-ingress-default-backend   ClusterIP      10.23.0.137   <none>        80/TCP                       14h
kube-system   dashboard-metrics-scraper                ClusterIP      10.23.0.143   <none>        8000/TCP                     21h
kube-system   kube-dns                                 ClusterIP      10.23.0.2     <none>        53/UDP,53/TCP                21h
kube-system   kubernetes-dashboard                     ClusterIP      10.23.0.23    <none>        443/TCP                      21h
kube-system   metrics-server                           ClusterIP      10.23.0.252   <none>        443/TCP                      21h
web           tripviewer                               ClusterIP      10.23.0.3     <none>        80/TCP                       9h


## Users
web-dev@otaprd1115ops.onmicrosoft.com / dfszdfzvsfcs322r3f2!
api-dev@otaprd1115ops.onmicrosoft.com / dfszdfzvsfcs322r3f2!


# Assign Role 'Azure Kubernetes Service Cluster User Role'

kubectl apply -f .\RBAC\api-dev.yaml
kubectl apply -f .\RBAC\web-dev.yaml

kubectl get rolebinding -A
NAMESPACE     NAME                                                AGE
api           api-dev-edit                                        66s
api           web-dev-view                                        60s
kube-public   system:controller:bootstrap-signer                  23h
kube-system   kubernetes-dashboard                                23h
kube-system   metrics-server-auth-reader                          23h
kube-system   node-view                                           23h
kube-system   system::extension-apiserver-authentication-reader   23h
kube-system   system::leader-locking-kube-controller-manager      23h
kube-system   system::leader-locking-kube-scheduler               23h
kube-system   system:controller:bootstrap-signer                  23h
kube-system   system:controller:cloud-provider                    23h
kube-system   system:controller:token-cleaner                     23h
kube-system   tunnelfront                                         23h
web           api-dev-view                                        66s
web           openhack-nginx-ingress                              47m
web           web-dev-edit                                        60s


# TEST
PS G:\git\openhack-containers> kubectl get svc -n api
To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code ASJFY2EUB to authenticate.
NAME          TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)   AGE
poi           ClusterIP   10.23.0.58    <none>        80/TCP    113m
trips         ClusterIP   10.23.0.30    <none>        80/TCP    113m
user-java     ClusterIP   10.23.0.204   <none>        80/TCP    113m
userprofile   ClusterIP   10.23.0.53    <none>        80/TCP    113m
PS G:\git\openhack-containers> kubectl get pods -n api
NAME                           READY   STATUS    RESTARTS   AGE
poi-f8cb89fb4-677xq            1/1     Running   0          114m
trips-69488577b8-qsml9         1/1     Running   0          113m
user-java-d6786cbb-mqrbs       1/1     Running   0          113m
userprofile-68ffcc6d84-7dtb4   1/1     Running   0          113m
PS G:\git\openhack-containers> kubectl get pods -n web
NAME                                                      READY   STATUS    RESTARTS   AGE
openhack-nginx-ingress-controller-85d95bb96-vrdzn         1/1     Running   0          77m
openhack-nginx-ingress-default-backend-789485f569-zrstl   1/1     Running   0          77m
tripviewer-75cb6fcc55-nd2dc                               1/1     Running   0          54m
PS G:\git\openhack-containers> kubectl get pods -n default
Error from server (Forbidden): pods is forbidden: User "web-dev@otaprd1115ops.onmicrosoft.com" cannot list resource "pods" in API group "" in the namespace "default"
PS G:\git\openhack-containers> kubectl delete pod poi-f8cb89fb4-677xq -n api
Error from server (Forbidden): pods "poi-f8cb89fb4-677xq" is forbidden: User "web-dev@otaprd1115ops.onmicrosoft.com" cannot delete resource "pods" in API group "" in the namespace "api"
PS G:\git\openhack-containers> kubectl delete pod tripviewer-75cb6fcc55-nd2dc -n web
pod "tripviewer-75cb6fcc55-nd2dc" deleted